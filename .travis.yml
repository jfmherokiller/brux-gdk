language: cpp
notifications:
  email: false
matrix:
  include:
  - os: osx
    osx_image: xcode11.3
    addons:
      homebrew:
        packages:
        - sdl2
        - sdl2_gfx
        - sdl2_image
        - sdl2_net
        - sdl2_mixer
    script: "./build.sh"
    cache:
      directories:
      - "$HOME/Library/Caches/Homebrew"
    before_cache:
    - brew cleanup
  - os: linux
    dist: bionic
    addons:
      apt:
        packages:
        - libsdl2-dev
        - libsdl2-mixer-dev
        - libsdl2-net-dev
        - libsdl2-gfx-dev
        - libsdl2-image-dev
    script:
    - pip install cmake
    - "./build.sh"
  - os: windows
    before_install:
    - |-
      case $TRAVIS_OS_NAME in
        windows)
          [[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64
          choco uninstall -y mingw
          choco upgrade --no-progress -y msys2
          export msys2='cmd //C RefreshEnv.cmd '
          export msys2+='& set MSYS=winsymlinks:nativestrict '
          export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
          export mingw64="$msys2 -mingw64 -full-path -here -c "\"\$@"\" --"
          export msys2+=" -msys2 -c "\"\$@"\" --"
          $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-toolchain
          ## Install more MSYS2 packages from https://packages.msys2.org/base here
          $msys2 pacman --sync --noconfirm --needed cmake mingw-w64-x86_64-ninja
          $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-SDL2 mingw-w64-x86_64-SDL2_image mingw-w64-x86_64-SDL2_net mingw-w64-x86_64-SDL2_mixer mingw-w64-x86_64-SDL2_gfx
          taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
          export PATH=/C/tools/msys64/mingw64/bin:$PATH
          export MAKE=mingw32-make  # so that Autotools can find it
          ;;
      esac
    before_cache:
    - |-
      case $TRAVIS_OS_NAME in
        windows)
          # https://unix.stackexchange.com/a/137322/107554
          $msys2 pacman --sync --clean --noconfirm
          $msys2 rm /C/tools/msys64/var/log/pacman.log
          ;;
      esac
    cache:
      directories:
      - "$HOME/AppData/Local/Temp/chocolatey"
      - "/C/tools/msys64"
    script:
    - mkdir build && cd build && cmake .. -DCMAKE_MAKE_PROGRAM=mingw32-make -G "MSYS Makefiles"
    - mingw32-make && zip -r ../build.zip BruxRelease
deploy:
  provider: releases
  api_key:
    secure: cT4g/J59e9j4P0Sx09zNNMF8zDARLpdByzyxK2ayCFm5IMPwmzDsy56G0m8BgVuJp/vop1EZpIk5yF2+RKX/4/Es6spv21BhXAivGqos4mkFOXAWk76vFR8OlH0ycG24Lljz2ROGwikrgA+xQIy+R/KnCmsSuU7Hhxozkh82QmHB/Vw5p+gdpBcTxEsoXpk82UoI8+wU46HGTw1psUx0CKRiGCP7J1Cr+ZvYiykS/+9OJAze2sPA79sh8IQ3oqsdNyaAZACvJd1BYwQnA6FwLTDnK/v+TQq8Fx6I+lnHx2EUxBSh7BKIhR2w0BAnLBgeqG+dIq2Sm+CIPeU4tmpS3EHV65cqP2orx+br7nIXYOTI+6m+QVRFyVkOs//vxG6ZC2FNAE6MQs8liEFR+/A5gm//pU2p0os4PAD3/QZu/1xnw5VXseAr1ZV+YjMcKaqDYqD5/WDjtL6iz/NVR6xU9Q9jLz9Ak/+OBGJygNN7g2/invBccALPts4R5FiX6qYqftBmRmB6auq6fZhuP2pXzuF2/5Ej1I4NbG763SZJGd4W9tXBkv/iR2plTXqlInc91+Iy9/7u4D+lX0ASDIr/0TLOMbSBqWgPU7TlNULIwZDlNAb17T5Q8CRhVkN7PbH+YSvI58WRqVXXOFdvoq9zvqCE7UXRjvF/SxnL+cT1+Ic=
  file: build.zip
  on:
    repo: jfmherokiller/brux-gdk
  skip_cleanup: 'true'
